// ============================================
// Your Chawk — Prisma Schema
// ============================================
// Database: Supabase PostgreSQL
// Run: npx prisma migrate dev --name init
// Then: npx prisma generate

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -------------------------------------------
// Worker — Workers and Contractors
// -------------------------------------------
model Worker {
  id                String   @id @default(uuid())
  phoneNumber       String   @unique
  name              String?
  skill             String?
  city              String?
  preferredLanguage String   @default("en") // "en", "hi", "kn", "bn"
  idImageUrl        String?
  role              String   @default("worker") // "worker" or "contractor"
  isOnboarded       Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  applications Application[]

  @@map("workers")
}

// -------------------------------------------
// Job — Posted by a contractor
// -------------------------------------------
model Job {
  id                String   @id @default(uuid())
  contractorPhone   String
  title             String?
  skillRequired     String
  wage              String
  city              String
  location          String?  // specific area within city
  workersNeeded     Int      @default(1)
  durationDays      Int?
  insuranceProvided Boolean  @default(false)
  status            String   @default("OPEN") // "OPEN", "FILLED", "CANCELLED"
  createdAt         DateTime @default(now())

  applications Application[]

  @@map("jobs")
}

// -------------------------------------------
// Application — Worker applying to / accepting a job
// -------------------------------------------
model Application {
  id                 String    @id @default(uuid())
  jobId              String
  workerPhone        String
  status             String    @default("PENDING") // "PENDING", "ACCEPTED", "REJECTED"
  otp                String?
  otpExpiresAt       DateTime?
  attendanceStatus   String    @default("NOT_MARKED") // "NOT_MARKED", "PRESENT", "ABSENT"
  attendanceMarkedAt DateTime?
  createdAt          DateTime  @default(now())

  job    Job    @relation(fields: [jobId], references: [id])
  worker Worker @relation(fields: [workerPhone], references: [phoneNumber])

  @@unique([jobId, workerPhone]) // prevent duplicate applications
  @@map("applications")
}

// -------------------------------------------
// ConversationHistory — Chat history for Claude context
// -------------------------------------------
model ConversationHistory {
  id          String   @id @default(uuid())
  phoneNumber String
  role        String   // "user" or "assistant"
  content     String
  createdAt   DateTime @default(now())

  @@index([phoneNumber, createdAt])
  @@map("conversation_history")
}

// -------------------------------------------
// ConversationState — Tracks multi-step flows (legacy, kept for backward compat)
// -------------------------------------------
model ConversationState {
  phoneNumber String   @id @unique
  currentStep String // e.g. "awaiting_name", "awaiting_skill"
  contextData Json     @default("{}") // stores partial form data
  role        String   @default("worker") // "worker" or "contractor"
  updatedAt   DateTime @updatedAt

  @@map("conversation_states")
}
