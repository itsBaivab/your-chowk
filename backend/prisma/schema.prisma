// ============================================
// Your Chawk — Prisma Schema
// ============================================
// Database: Neon PostgreSQL
// Run: npx prisma db push
// Then: npx prisma generate

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -------------------------------------------
// Worker — Workers and Contractors
// -------------------------------------------
model Worker {
  id                String    @id @default(uuid())
  phoneNumber       String    @unique
  name              String?
  skill             String?
  city              String?
  preferredLanguage String    @default("en") // "en", "hi", "kn", "bn"
  aadhaarNumber     String? // 12-digit Aadhaar card number
  panNumber         String? // PAN card number (contractors)
  role              String    @default("worker") // "worker" or "contractor"
  isOnboarded       Boolean   @default(false)
  availableFrom     DateTime? // null = available now, date = busy until this date
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  applications Application[]

  @@map("workers")
}

// -------------------------------------------
// Job — Posted by a contractor
// -------------------------------------------
model Job {
  id                String   @id @default(uuid())
  contractorPhone   String
  title             String?
  skillRequired     String
  wage              String
  city              String
  location          String? // specific area within city
  meetingPoint      String? // where workers should meet on day 1
  workersNeeded     Int      @default(1)
  startDate         DateTime
  endDate           DateTime
  insuranceProvided Boolean  @default(false)
  status            String   @default("OPEN") // "OPEN", "FILLED", "CANCELLED"
  createdAt         DateTime @default(now())

  applications Application[]

  @@map("jobs")
}

// -------------------------------------------
// Application — Worker-Job lifecycle
// -------------------------------------------
// Status flow:
//   NOTIFIED → WORKER_ACCEPTED → CONTRACTOR_CONFIRMED → COMPLETED
//   Any state before CONTRACTOR_CONFIRMED → CANCELLED
model Application {
  id                 String    @id @default(uuid())
  jobId              String
  workerPhone        String
  status             String    @default("NOTIFIED") // NOTIFIED, WORKER_ACCEPTED, CONTRACTOR_CONFIRMED, CANCELLED, COMPLETED
  cancelledBy        String? // "worker" or "contractor" (when status=CANCELLED)
  otp                String?
  otpExpiresAt       DateTime?
  attendanceStatus   String    @default("NOT_MARKED") // "NOT_MARKED", "PRESENT", "ABSENT"
  attendanceMarkedAt DateTime?
  createdAt          DateTime  @default(now())

  job    Job    @relation(fields: [jobId], references: [id])
  worker Worker @relation(fields: [workerPhone], references: [phoneNumber])

  @@unique([jobId, workerPhone]) // prevent duplicate applications
  @@map("applications")
}

// -------------------------------------------
// ConversationHistory — Chat history for Claude context
// -------------------------------------------
model ConversationHistory {
  id          String   @id @default(uuid())
  phoneNumber String
  role        String // "user" or "assistant"
  content     String
  createdAt   DateTime @default(now())

  @@index([phoneNumber, createdAt])
  @@map("conversation_history")
}
