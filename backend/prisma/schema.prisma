// ============================================
// Kaam Milega — Prisma Schema
// ============================================
// Database: Supabase PostgreSQL
// Run: npx prisma migrate dev --name init
// Then: npx prisma generate

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -------------------------------------------
// Worker — A daily-wage labourer
// -------------------------------------------
model Worker {
  id                String   @id @default(uuid())
  phoneNumber       String   @unique
  name              String?
  skill             String?
  location          String?
  preferredLanguage String   @default("en") // "hi", "bn", "en"
  idImageUrl        String?
  role              String   @default("worker") // "worker" or "contractor"
  createdAt         DateTime @default(now())

  applications Application[]

  @@map("workers")
}

// -------------------------------------------
// Job — Posted by a contractor
// -------------------------------------------
model Job {
  id              String   @id @default(uuid())
  contractorPhone String
  title           String?
  skillRequired   String
  wage            String
  location        String
  workersNeeded   Int      @default(1)
  status          String   @default("OPEN") // "OPEN", "FILLED", "CANCELLED"
  createdAt       DateTime @default(now())

  applications Application[]

  @@map("jobs")
}

// -------------------------------------------
// Application — Worker applying to a job
// -------------------------------------------
model Application {
  id          String   @id @default(uuid())
  jobId       String
  workerPhone String
  status      String   @default("PENDING") // "PENDING", "ACCEPTED", "REJECTED"
  createdAt   DateTime @default(now())

  job    Job    @relation(fields: [jobId], references: [id])
  worker Worker @relation(fields: [workerPhone], references: [phoneNumber])

  @@unique([jobId, workerPhone]) // prevent duplicate applications
  @@map("applications")
}

// -------------------------------------------
// ConversationState — Tracks multi-step flows
// -------------------------------------------
model ConversationState {
  phoneNumber String   @id @unique
  currentStep String // e.g. "awaiting_name", "awaiting_skill"
  contextData Json     @default("{}") // stores partial form data
  role        String   @default("worker") // "worker" or "contractor"
  updatedAt   DateTime @updatedAt

  @@map("conversation_states")
}
